{{- if .Values.prometheusRule.enabled -}}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ include "kube-assist.fullname" . }}
  namespace: {{ .Values.prometheusRule.namespace | default .Release.Namespace }}
  labels:
    {{- include "kube-assist.labels" . | nindent 4 }}
    {{- with .Values.prometheusRule.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  groups:
    - name: kube-assist
      rules:
        - alert: KubeAssistAIDegraded
          expr: kubeassist_ai_degraded == 1
          for: 5m
          labels:
            severity: {{ .Values.prometheusRule.alertSeverity.aiDegraded | default "warning" }}
          annotations:
            summary: "KubeAssist AI provider is degraded"
            description: "The AI circuit breaker has been open for more than 5 minutes. AI-powered analysis is unavailable."
        - alert: KubeAssistHighReconcileErrors
          expr: rate(kubeassist_reconcile_total{result="error"}[5m]) > 0.01
          for: 10m
          labels:
            severity: {{ .Values.prometheusRule.alertSeverity.reconcileErrors | default "warning" }}
          annotations:
            summary: "KubeAssist reconciliation errors detected"
            description: "KubeAssist has been producing reconciliation errors for more than 10 minutes."
        - alert: KubeAssistBudgetNearLimit
          expr: kubeassist_ai_budget_tokens_used / kubeassist_ai_budget_tokens_limit > 0.9 and kubeassist_ai_budget_tokens_limit > 0
          for: 15m
          labels:
            severity: {{ .Values.prometheusRule.alertSeverity.budgetNearLimit | default "info" }}
          annotations:
            summary: "KubeAssist AI token budget near limit"
            description: "AI token usage has exceeded 90% of the budget limit for more than 15 minutes."
        {{- with .Values.prometheusRule.additionalRules }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
{{- end }}
